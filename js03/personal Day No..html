<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ãƒ‘ãƒ¼ã‚½ãƒŠãƒ«ãƒ‡ã‚¤ãƒŠãƒ³ãƒãƒ¼å ã„ãƒãƒ£ãƒƒãƒˆ</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    input, select, button { margin: 5px; padding: 5px; }
    #output { border: 1px solid #ccc; padding: 10px; height: 300px; overflow: auto; margin-top: 10px; }
    .message { border-bottom: 1px solid #eee; margin-bottom: 10px; padding-bottom: 5px; }
    .delete-btn { font-size: 0.8em; color: red; cursor: pointer; }
  </style>
</head>
<body>

<h2>ğŸ”® ãƒ‘ãƒ¼ã‚½ãƒŠãƒ«ãƒ‡ã‚¤ãƒŠãƒ³ãƒãƒ¼å ã„ãƒãƒ£ãƒƒãƒˆ</h2>
<p style="margin-bottom: 20px; color: #555;">
    ã‚ãªãŸã®ç”Ÿå¹´æœˆæ—¥ã¨å ã„ãŸã„æ—¥ä»˜ã‹ã‚‰ã€<strong>ã‚ãªãŸã ã‘ã®é‹å‹¢</strong>ã‚’å°ãã¾ã™ã€‚
  </p>
<div>
  <label>ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ : <input type="text" id="uname"></label><br>

  <label>ç”Ÿå¹´æœˆæ—¥:
    <select id="birth_year"></select>å¹´
    <select id="birth_month"></select>æœˆ
    <select id="birth_day"></select>æ—¥
  </label><br>

  <label>å ã„ãŸã„æ—¥: <input type="date" id="target"></label><br>
  <button id="send">å ã†</button>
</div>

<div id="output"></div>

<!-- Firebase & jQuery -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
  import { getDatabase, ref, push, set, onChildAdded, remove } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-database.js";

  const firebaseConfig = {
    // è‡ªåˆ†ã®Firebaseè¨­å®šã«å·®ã—æ›¿ãˆ
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
    databaseURL: "https://YOUR_PROJECT_ID.firebaseio.com",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_PROJECT_ID.appspot.com",
    messagingSenderId: "YOUR_SENDER_ID",
    appId: "YOUR_APP_ID"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const dbRef = ref(db, "personal_day_chat");

  // ç”Ÿå¹´æœˆæ—¥ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³åˆæœŸåŒ–
  const yearSel = document.getElementById("birth_year");
  const monthSel = document.getElementById("birth_month");
  const daySel = document.getElementById("birth_day");

  for (let y = 1920; y <= new Date().getFullYear(); y++) {
    const opt = document.createElement("option");
    opt.value = y;
    opt.text = y;
    yearSel.appendChild(opt);
  }

  for (let m = 1; m <= 12; m++) {
    const opt = document.createElement("option");
    opt.value = m.toString().padStart(2, '0');
    opt.text = m;
    monthSel.appendChild(opt);
  }

  for (let d = 1; d <= 31; d++) {
    const opt = document.createElement("option");
    opt.value = d.toString().padStart(2, '0');
    opt.text = d;
    daySel.appendChild(opt);
  }

  // å ã„é€ä¿¡
  $("#send").on("click", function () {
    const uname = $("#uname").val();
    const year = $("#birth_year").val();
    const month = $("#birth_month").val();
    const day = $("#birth_day").val();
    const target = $("#target").val();

    if (!uname || !year || !month || !day || !target) {
      alert("ã™ã¹ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
      return;
    }

    const birth = `${year}-${month}-${day}`;
    const number = getPersonalDayNumber(birth, target);
    const result = getFortuneMessage(number);

    const msg = {
      uname,
      birth,
      target,
      number,
      result,
      created_at: new Date().toLocaleString()
    };

    const newPostRef = push(dbRef);
    set(newPostRef, msg);
  });

  // è¡¨ç¤ºé ˜åŸŸã«è¿½åŠ 
  onChildAdded(dbRef, function (data) {
    const msg = data.val();
    const key = data.key;
    let html = `<div class="message" id="${key}">
      <strong>ğŸ‘¤ ${msg.uname}</strong>ï¼ˆ${msg.birth}ç”Ÿã¾ã‚Œï¼‰<br>
      ğŸ“… å ã„æ—¥: ${msg.target}<br>
      ğŸ”¢ ãƒ‘ãƒ¼ã‚½ãƒŠãƒ«ãƒ‡ã‚¤No.: ${msg.number}<br>
      ğŸ’¬ ${msg.result}<br>
      ğŸ•“ ${msg.created_at}<br>
      <span class="delete-btn" onclick="deleteMessage('${key}')">[å‰Šé™¤]</span>
    </div>`;
    $("#output").append(html);
    $("#output").scrollTop($("#output")[0].scrollHeight);
  });

  window.deleteMessage = function (key) {
    remove(ref(db, "personal_day_chat/" + key));
    $("#" + key).remove();
  }

  function getPersonalDayNumber(birthStr, targetStr) {
    const birth = new Date(birthStr);
    const target = new Date(targetStr);
    const birthSum = sumDigits(birth.getFullYear()) + sumDigits(birth.getMonth() + 1) + sumDigits(birth.getDate());
    const targetSum = sumDigits(target.getFullYear()) + sumDigits(target.getMonth() + 1) + sumDigits(target.getDate());
    let total = birthSum + targetSum;
    while (total > 9) total = sumDigits(total);
    return total;
  }

  function sumDigits(num) {
    return num.toString().split("").reduce((acc, d) => acc + parseInt(d), 0);
  }

  function getFortuneMessage(num) {
    const messages = {
      1: "ä»Šæ—¥ã¯æ–°ãŸãªæŒ‘æˆ¦ã«ã´ã£ãŸã‚Šã®æ—¥ã€‚è‡ªåˆ†ã‹ã‚‰ä¸€æ­©è¸ã¿å‡ºã—ã¦ã¿ã¦ï¼",
      2: "äººã¨ã®é–¢ã‚ã‚ŠãŒã‚«ã‚®ã€‚æ€ã„ã‚„ã‚Šã¨å”åŠ›ã‚’æ„è­˜ã—ã¦éã”ãã†ã€‚",
      3: "å‰µé€ åŠ›ã¨ç™ºä¿¡åŠ›ãŒå…‰ã‚‹æ—¥ã€‚æ¥½ã—ã„ã“ã¨ã«ç›®ã‚’å‘ã‘ã¦â—",
      4: "ã‚³ãƒ„ã‚³ãƒ„ç©ã¿ä¸Šã’ã‚‹åŠ›ãŒè©¦ã•ã‚Œã‚‹æ—¥ã€‚åœ°é“ãªåŠªåŠ›ãŒå‰ï¼",
      5: "å¤‰åŒ–ã®æµã‚ŒãŒå¼·ã„ä¸€æ—¥ã€‚æŸ”è»Ÿã«å‹•ã„ã¦é¢¨ã«ä¹—ã‚ã†ã€‚",
      6: "å®¶åº­ã‚„ä»²é–“ã¨ã®æ™‚é–“ã‚’å¤§åˆ‡ã«ã€‚å„ªã—ã•ãŒé‹ã‚’å‘¼ã³ã¾ã™ã€‚",
      7: "å†…çœã«å‘ã„ãŸæ—¥ã€‚é™ã‹ãªæ™‚é–“ãŒã‚ãªãŸã«æ°—ã¥ãã‚’ã‚‚ãŸã‚‰ã—ã¾ã™ã€‚",
      8: "æˆæœã‚’æ„è­˜ã™ã‚‹ã¨è‰¯ã„æ—¥ã€‚ãŠé‡‘ã‚„ä»•äº‹é‹ã«å‹•ããŒã‚ã‚Šãã†ã€‚",
      9: "æ‰‹æ”¾ã—ã¨ç™’ã—ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã€‚éå»ã‚’æŒ¯ã‚Šè¿”ã‚‹ã“ã¨ã§å‰ã«é€²ã‚ã¾ã™ã€‚"
    };
    return messages[num] || "ä»Šæ—¥ã¯ãƒãƒ©ãƒ³ã‚¹ã®å–ã‚ŒãŸç©ã‚„ã‹ãªæ—¥ã§ã™ã€‚";
  }

  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§æœ¬æ—¥ã‚’ã‚»ãƒƒãƒˆ
  const today = new Date().toISOString().split("T")[0];
  document.getElementById("target").value = today;
</script>

</body>
</html>